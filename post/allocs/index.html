    <!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="author" content="violetear">
		<meta name="description" content="Go HTTP router">
		<meta name="keywords" content="router, http, http2, dynamic, rest, versioning, api">
		<meta name="generator" content="Hugo 0.29" />
		<title>Benchmarks and profiling &middot; violetear</title>
        <link rel="apple-touch-icon" sizes="57x57" href="https://violetear.org/images/apple-icon-57x57.png">
        <link rel="apple-touch-icon" sizes="60x60" href="https://violetear.org/images/apple-icon-60x60.png">
        <link rel="apple-touch-icon" sizes="72x72" href="https://violetear.org/images/apple-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="76x76" href="https://violetear.org/images/apple-icon-76x76.png">
        <link rel="apple-touch-icon" sizes="114x114" href="https://violetear.org/images/apple-icon-114x114.png">
        <link rel="apple-touch-icon" sizes="120x120" href="https://violetear.org/images/apple-icon-120x120.png">
        <link rel="apple-touch-icon" sizes="144x144" href="https://violetear.org/images/apple-icon-144x144.png">
        <link rel="apple-touch-icon" sizes="152x152" href="https://violetear.org/images/apple-icon-152x152.png">
        <link rel="apple-touch-icon" sizes="180x180" href="https://violetear.org/images/apple-icon-180x180.png">
        <link rel="icon" type="image/png" sizes="192x192"  href="https://violetear.org/images/android-icon-192x192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="https://violetear.org/images/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="96x96" href="https://violetear.org/images/favicon-96x96.png">
        <link rel="icon" type="image/png" sizes="16x16" href="https://violetear.org/images/favicon-16x16.png">
		<link rel="shortcut icon" href="https://violetear.org/images/favicon.ico">
		<link rel="stylesheet" href="https://violetear.org/css/style.css">
		<link rel="stylesheet" href="https://violetear.org/css/highlight.css">
		

		
		<link rel="stylesheet" href="https://violetear.org/css/monosocialiconsfont.css">
		

		
		<link href="https://violetear.org/index.xml" rel="alternate" type="application/rss+xml" title="violetear" />
		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='https://violetear.org/'> <span class="arrow">‚Üê</span>Home</a>
	

	
		<a href="https://github.com/nbari/violetear/">Github</a>
		<a href="https://github.com/nbari/violetear/issues">Issues</a>
		<a href='https://violetear.org/about'>About</a>
	

	
	<a class="cta" href="https://violetear.org/index.xml">Subscribe</a>
	
</nav>

        <section id="wrapper">
            <article class="post">
                <header>
                    <h1>Benchmarks and profiling</h1>
                    <h2 class="headline">
                    <br>
                    
                    
                        
                            <a href="https://violetear.org/tags/benchmark">benchmark</a>
                        
                            <a href="https://violetear.org/tags/profiling">profiling</a>
                        
                            <a href="https://violetear.org/tags/allocs">allocs</a>
                        
                    
                    
                    </h2>
                </header>
                <section id="post-body">
                    

<p><em>Go is fast, but when doing things carefully, besides being faster is very light.</em></p>

<p>The history about violetear is not much different from many others - an HTTP
router capable of handling any requests.</p>

<p>One of the main constraints found at the beginning was how to deal with static
and dynamic URLs, let&rsquo;s face it if you want to replace an important component of
your current architecture you should try to break as less as possible - highly
trained monkeys hate changes. üêí</p>

<p>For example, the need to support this type of requests:</p>

<pre><code class="language-html">host.tld/static/8E605AD7-554A-450D-A72D-D0098D336E8E/127.0.0.1
        \_____/\_____________________________________________/
           |                         |
         static                   dynamic

host.tld/static/127.0.0.1/8E605AD7-554A-450D-A72D-D0098D336E8E
        \_____/\_____________________________________________/
           |                         |
         static                   dynamic
</code></pre>

<p>Which could be represented in the router like:</p>

<pre><code class="language-go">uuid := `[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}`
router.AddRegex(&quot;:uuid&quot;, uuid)
router.AddRegex(&quot;:ipv4&quot;, `^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$`)
router.HandleFunc(&quot;/static/:uuid/:ipv4&quot;, handleUUID, &quot;PUT&quot;)
router.HandleFunc(&quot;/static/:ipv4/:uuid&quot;, handleIPV$, &quot;GET,HEAD&quot;)
</code></pre>

<p>While implementing this, the use of regular expressions was inevitable, but by
using them where they were not required, they came with a big penalty.</p>

<p>This is how the router was splitting the path for all requests:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span><span style=""> </span><span style="color:#a6e22e">splitPathRx</span><span style=""> </span><span style="">=</span><span style=""> </span><span style="color:#a6e22e">regexp</span><span style="">.</span><span style="color:#a6e22e">MustCompile</span><span style="">(</span><span style="color:#e6db74">`[^/ ]+`</span><span style="">)</span><span style="">
</span><span style="">
</span><span style=""></span><span style="color:#75715e">// splitPath returns an slice of the path
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span><span style=""> </span><span style="">(</span><span style="color:#a6e22e">r</span><span style=""> </span><span style="color:#f92672">*</span><span style="color:#a6e22e">Router</span><span style="">)</span><span style=""> </span><span style="color:#a6e22e">splitPath</span><span style="">(</span><span style="color:#a6e22e">p</span><span style=""> </span><span style="color:#66d9ef">string</span><span style="">)</span><span style=""> </span><span style="">[]</span><span style="color:#66d9ef">string</span><span style=""> </span><span style="">{</span><span style="">
</span><span style="background-color:#3c3d38;display:block;width:100%"><span style="">	</span><span style="color:#a6e22e">pathParts</span><span style=""> </span><span style="color:#f92672">:=</span><span style=""> </span><span style="color:#a6e22e">splitPathRx</span><span style="">.</span><span style="color:#a6e22e">FindAllString</span><span style="">(</span><span style="color:#a6e22e">p</span><span style="">,</span><span style=""> </span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="">)</span><span style="">
</span></span><span style="">
</span><span style="">	</span><span style="color:#75715e">// root (empty slice)
</span><span style="color:#75715e"></span><span style="">	</span><span style="color:#66d9ef">if</span><span style=""> </span><span style="">len</span><span style="">(</span><span style="color:#a6e22e">pathParts</span><span style="">)</span><span style=""> </span><span style="color:#f92672">==</span><span style=""> </span><span style="color:#ae81ff">0</span><span style=""> </span><span style="">{</span><span style="">
</span><span style="">		</span><span style="color:#a6e22e">pathParts</span><span style=""> </span><span style="">=</span><span style=""> </span><span style="">append</span><span style="">(</span><span style="color:#a6e22e">pathParts</span><span style="">,</span><span style=""> </span><span style="color:#e6db74">&#34;/&#34;</span><span style="">)</span><span style="">
</span><span style="">	</span><span style="">}</span><span style="">
</span><span style="">
</span><span style="">	</span><span style="color:#66d9ef">return</span><span style=""> </span><span style="color:#a6e22e">pathParts</span><span style="">
</span><span style=""></span><span style="">}</span></code></pre>
</div>

<h1 id="pprof">pprof</h1>

<p>Go comes with &ldquo;batteries included&rdquo; and is very easy to start profiling the code by the
use of the package <a href="https://golang.org/pkg/net/http/pprof/">pprof</a>.</p>

<p>The first goal was find the bottlenecks, the following code was used for this:</p>

<pre><code class="language-go">package main

import (
	&quot;net/http&quot;
	&quot;net/http/pprof&quot;

	&quot;github.com/nbari/violetear&quot;
)

func hello(w http.ResponseWriter, r *http.Request) {
	w.Write([]byte(&quot;hello&quot;))
}

func main() {
	r := violetear.New()
	r.AddRegex(&quot;:word&quot;, `^\w+$`)
	r.HandleFunc(&quot;/hello&quot;, hello, &quot;GET,HEAD&quot;)
	r.HandleFunc(&quot;/hello/:word/&quot;, hello, &quot;GET,HEAD&quot;)
	r.HandleFunc(&quot;/*&quot;, hello, &quot;GET,HEAD&quot;)

	// Register pprof handlers
	r.HandleFunc(&quot;/debug/pprof/*&quot;, pprof.Index)
	r.HandleFunc(&quot;/debug/pprof/cmdline&quot;, pprof.Cmdline)
	r.HandleFunc(&quot;/debug/pprof/profile&quot;, pprof.Profile)
	r.HandleFunc(&quot;/debug/pprof/symbol&quot;, pprof.Symbol)
	r.HandleFunc(&quot;/debug/pprof/trace&quot;, pprof.Trace)

	http.ListenAndServe(&quot;:8080&quot;, r)
}
</code></pre>

<p>Notice the <code>pprof</code> handlers:</p>

<pre><code class="language-go">// Register pprof handlers
r.HandleFunc(&quot;/debug/pprof/*&quot;, pprof.Index)
r.HandleFunc(&quot;/debug/pprof/cmdline&quot;, pprof.Cmdline)
r.HandleFunc(&quot;/debug/pprof/profile&quot;, pprof.Profile)
r.HandleFunc(&quot;/debug/pprof/symbol&quot;, pprof.Symbol)
r.HandleFunc(&quot;/debug/pprof/trace&quot;, pprof.Trace)
</code></pre>

<p>For making some random requests, <code>wrk</code> + <code>lua</code> do a nice combo, this is the
command I used for testing:</p>

<pre><code class="language-sh">$ wrk -c100 -d10 -t2 -s counter.lua http://0:8080/
</code></pre>

<p>And the contents of the <code>counter.lua</code> script:</p>

<pre><code class="language-lua">counter = 0

request = function()
    if counter % 100 == 0 then
	    path = &quot;/&quot;
    else
	    path = path .. counter .. &quot;/&quot;
    end
    wrk.headers[&quot;X-Counter&quot;] = counter
    counter = counter + 1
    return wrk.format(nil, path)
end
</code></pre>

<p>This basically will make requests in the following way:</p>

<pre><code class="language-html">/
/.
/./.
/././.
/./././.
/././././.
/./././././.
/././././././.
/./././././././.
/././././././././.
...
</code></pre>

<p>It is very basic but allows to test the router with both static and dynamic
handlers.</p>

<p>Once everything is setup, the router should be up and running and listening for
requests, <code>wrk</code> is called like mentioned before and in another terminal this
command is used:</p>

<pre><code class="language-sh">go tool pprof http://0:8080/debug/pprof/heap
</code></pre>

<p>After running the command you enter into an interactive mode, there I typed
<code>top</code> and got this output:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 1</span><span style="">(pprof) top
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 2</span><span style="">Showing nodes accounting for 4694.50kB, 100% of 4694.50kB total
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 3</span><span style="">Showing top 10 nodes out of 25
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 4</span><span style="">      flat  flat%   sum%        cum   cum%
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 5</span><span style=""> 3155.84kB 67.22% 67.22%  3155.84kB 67.22%  regexp.(*bitState).reset /usr/local/Cellar/go/1.9/libexec/src/regexp/backtrack.go
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 6</span><span style="">     514kB 10.95% 78.17%      514kB 10.95%  bufio.NewWriterSize /usr/local/Cellar/go/1.9/libexec/src/bufio/bufio.go
</span><span style="background-color:#3c3d38;display:block;width:100%"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 7</span><span style="">  512.62kB 10.92% 89.09%   512.62kB 10.92%  regexp.(*Regexp).FindAllString.func1 /usr/local/Cellar/go/1.9/libexec/src/regexp/regexp.go
</span></span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 8</span><span style="">  512.03kB 10.91%   100%   512.03kB 10.91%  syscall.anyToSockaddr /usr/local/Cellar/go/1.9/libexec/src/syscall/syscall_bsd.go
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 9</span><span style="">         0     0%   100%  3668.46kB 78.14%  github.com/nbari/violetear.(*Router).ServeHTTP /Users/nbari/projects/go/src/github.com/nbari/violetear/violetear.go
</span><span style="background-color:#3c3d38;display:block;width:100%"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">10</span><span style="">         0     0%   100%  3668.46kB 78.14%  github.com/nbari/violetear.(*Router).splitPath /Users/nbari/projects/go/src/github.com/nbari/violetear/violetear.go
</span></span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">11</span><span style="">         0     0%   100%   512.03kB 10.91%  internal/poll.(*FD).Accept /usr/local/Cellar/go/1.9/libexec/src/internal/poll/fd_unix.go
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">12</span><span style="">         0     0%   100%   512.03kB 10.91%  internal/poll.accept /usr/local/Cellar/go/1.9/libexec/src/internal/poll/sys_cloexec.go
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">13</span><span style="">         0     0%   100%   512.03kB 10.91%  main.main /Users/nbari/projects/go/src/github.com/nbari/go-sandbox/profile-violetear/profile/main.go
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">14</span><span style="">         0     0%   100%   512.03kB 10.91%  net.(*TCPListener).AcceptTCP /usr/local/Cellar/go/1.9/libexec/src/net/tcpsock.go</span></code></pre>
</div>

<blockquote>
<p>Notice lines 7 and 10</p>
</blockquote>

<p>Still in the interactive mode, I typed: <code>list splitPath</code> this helps to show the
lines of code, this was the output:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 1</span><span style="">(pprof) list splitPath
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 2</span><span style="">Total: 2.02MB
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 3</span><span style="">ROUTINE ======================== github.com/nbari/violetear.(*Router).splitPath in /Users/nbari/projects/go/src/github.com/nbari/violetear/violetear.go
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 4</span><span style="">         0     1.02MB (flat, cum) 50.37% of Total
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 5</span><span style="">         .          .    261:   return
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 6</span><span style="">         .          .    262:}
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 7</span><span style="">         .          .    263:
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 8</span><span style="">         .          .    264:// splitPath returns an slice of the path
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 9</span><span style="">         .          .    265:func (r *Router) splitPath(p string) []string {
</span><span style="background-color:#3c3d38;display:block;width:100%"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">10</span><span style="">         .     1.02MB    266:   pathParts := splitPathRx.FindAllString(p, -1)
</span></span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">11</span><span style="">         .          .    267:
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">12</span><span style="">         .          .    268:   // root (empty slice)
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">13</span><span style="">         .          .    269:   if len(pathParts) == 0 {
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">14</span><span style="">         .          .    270:           pathParts = append(pathParts, &#34;/&#34;)
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">15</span><span style="">         .          .    271:   }
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">16</span><span style="">(pprof)</span></code></pre>
</div>

<p>Was evident that splitting the path by using a regular expression was the most
efficient way to go, I changed the function to someethinig like this:</p>

<pre><code class="language-go">func (r *Router) splitPath(p string) []string {
        pathParts := strings.FieldsFunc(p, func(c rune) bool {
                return c == '/'
        })
        // root (empty slice)
        if len(pathParts) == 0 {
                return []string{&quot;/&quot;}
        }
        return pathParts
}
</code></pre>

<p>I created a small bench test:</p>

<pre><code class="language-go">package violetear

import (
	&quot;net/http&quot;
	&quot;testing&quot;
)

func benchRequest(b *testing.B, router http.Handler, r *http.Request) {
	w := &amp;ResponseWriter{}
	u := r.URL
	rq := u.RawQuery
	r.RequestURI = u.RequestURI()
	b.ReportAllocs()
	b.ResetTimer()

	for i := 0; i &lt; b.N; i++ {
		u.RawQuery = rq
		router.ServeHTTP(w, r)
	}
}

func BenchmarkRouterStatic(b *testing.B) {
	router := New()
	router.HandleFunc(&quot;/hello&quot;, func(w http.ResponseWriter, r *http.Request) {}, &quot;GET,HEAD&quot;)
	r, _ := http.NewRequest(&quot;GET&quot;, &quot;/hello&quot;, nil)
	benchRequest(b, router, r)
}

func BenchmarkRouterDynamic(b *testing.B) {
	router := New()
	router.AddRegex(&quot;:word&quot;, `^\w+$`)
	router.HandleFunc(&quot;/test/:word&quot;, func(w http.ResponseWriter, r *http.Request) {}, &quot;GET,HEAD&quot;)
	r, _ := http.NewRequest(&quot;GET&quot;, &quot;/test/foo&quot;, nil)
	benchRequest(b, router, r)
}
</code></pre>

<p>And run it using:</p>

<pre><code>go test -run=^$ -bench=.
</code></pre>

<p>The output was a small win of 3 allocation less:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 1</span><span style="">$ go test -run=^$ -bench=.
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 2</span><span style="">2017/10/02 18:47:23 Adding path: /hello [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 3</span><span style="">goos: darwin
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 4</span><span style="">goarch: amd64
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 5</span><span style="">pkg: github.com/nbari/violetear
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 6</span><span style="">BenchmarkRouterStatic-4         2017/10/02 18:47:23 Adding path: /hello [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 7</span><span style="">2017/10/02 18:47:23 Adding path: /hello [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 8</span><span style="">2017/10/02 18:47:23 Adding path: /hello [GET,HEAD]
</span><span style="background-color:#3c3d38;display:block;width:100%"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 9</span><span style=""> 2000000               692 ns/op             616 B/op         10 allocs/op
</span></span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">10</span><span style="">2017/10/02 18:47:25 Adding path: /test/:word [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">11</span><span style="">BenchmarkRouterDynamic-4        2017/10/02 18:47:25 Adding path: /test/:word [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">12</span><span style="">2017/10/02 18:47:25 Adding path: /test/:word [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">13</span><span style="">2017/10/02 18:47:25 Adding path: /test/:word [GET,HEAD]
</span><span style="background-color:#3c3d38;display:block;width:100%"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">14</span><span style=""> 1000000              1256 ns/op             936 B/op         12 allocs/op
</span></span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">15</span><span style="">PASS
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">16</span><span style="">ok      github.com/nbari/violetear      3.380s</span></code></pre>
</div>

<p>Before doing the changes this was the output 11 allocations for static routes
and 14 for dynamic üê¢</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 1</span><span style="">$ go test -run=^$ -bench=.
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 2</span><span style="">2017/10/02 09:56:34 Adding path: /hello [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 3</span><span style="">goos: darwin
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 4</span><span style="">goarch: amd64
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 5</span><span style="">pkg: github.com/nbari/violetear
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 6</span><span style="">BenchmarkRouterStatic-4         2017/10/02 09:56:34 Adding path: /hello [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 7</span><span style="">2017/10/02 09:56:34 Adding path: /hello [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 8</span><span style="">2017/10/02 09:56:34 Adding path: /hello [GET,HEAD]
</span><span style="background-color:#3c3d38;display:block;width:100%"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 9</span><span style="">1000000              1145 ns/op             776 B/op         11 allocs/op
</span></span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">10</span><span style="">2017/10/02 09:56:35 Adding path: /test/:word [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">11</span><span style="">BenchmarkRouterDynamic-4        2017/10/02 09:56:35 Adding path: /test/:word [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">12</span><span style="">2017/10/02 09:56:35 Adding path: /test/:word [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">13</span><span style="">2017/10/02 09:56:35 Adding path: /test/:word [GET,HEAD]
</span><span style="background-color:#3c3d38;display:block;width:100%"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">14</span><span style="">1000000              1835 ns/op            1096 B/op         14 allocs/op
</span></span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">15</span><span style="">PASS
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">16</span><span style="">ok      github.com/nbari/violetear      3.029s</span></code></pre>
</div>

<p>To get more info about the allocations, I mainly used
<code>pprof</code> with options like <code>alloc_space</code>:</p>

<pre><code class="language-sh">go tool pprof --alloc_space  http://0:8080/debug/pprof/heap
</code></pre>

<p>When setting <code>allocfreetrace=1</code> to environment variable GODEBUG, you can see
stacktrace where allocation occurs:</p>

<pre><code class="language-html">allocfreetrace: setting allocfreetrace=1 causes every allocation to be
profiled and a stack trace printed on each object's allocation and free.
</code></pre>

<p>To build the tests:</p>

<pre><code class="language-sh">    $ go test -c
</code></pre>

<p>And to run the tests writing to a file all the output:</p>

<pre><code class="language-sh">GODEBUG=allocfreetrace=1 ./test.test -test.run=none -test.bench=BenchmarkRouter -test.benchtime=10ms 2&gt;trace.log
</code></pre>

<p>After doing all this I was available to save up tu 90% of the allocations for
static routes, from 11 to 1:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 1</span><span style="">$ go test -run=^$ -bench=.
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 2</span><span style="">2017/10/02 09:51:47 Adding path: /hello [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 3</span><span style="">goos: darwin
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 4</span><span style="">goarch: amd64
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 5</span><span style="">pkg: github.com/nbari/violetear
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 6</span><span style="">BenchmarkRouterStatic-4         2017/10/02 09:51:47 Adding path: /hello [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 7</span><span style="">2017/10/02 09:51:47 Adding path: /hello [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 8</span><span style="">2017/10/02 09:51:47 Adding path: /hello [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 9</span><span style="">2017/10/02 09:51:47 Adding path: /hello [GET,HEAD]
</span><span style="background-color:#3c3d38;display:block;width:100%"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">10</span><span style="">10000000               213 ns/op              16 B/op          1 allocs/op
</span></span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">11</span><span style="">2017/10/02 09:51:50 Adding path: /test/:word [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">12</span><span style="">BenchmarkRouterDynamic-4        2017/10/02 09:51:50 Adding path: /test/:word [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">13</span><span style="">2017/10/02 09:51:50 Adding path: /test/:word [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">14</span><span style="">2017/10/02 09:51:50 Adding path: /test/:word [GET,HEAD]
</span><span style="background-color:#3c3d38;display:block;width:100%"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">15</span><span style="">1000000              1115 ns/op             816 B/op          7 allocs/op
</span></span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">16</span><span style="">PASS
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">17</span><span style="">ok      github.com/nbari/violetear      3.507s</span></code></pre>
</div>

<h1 id="0-allocations">0 allocations</h1>

<p>Make it happen üòÉ</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 1</span><span style="">$ go test -run=^$ -bench=.
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 2</span><span style="">2017/10/05 21:57:31 Adding path: /hello [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 3</span><span style="">goos: darwin
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 4</span><span style="">goarch: amd64
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 5</span><span style="">pkg: github.com/nbari/violetear
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 6</span><span style="">BenchmarkRouterStatic-4         2017/10/05 21:57:31 Adding path: /hello [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 7</span><span style="">2017/10/05 21:57:31 Adding path: /hello [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 8</span><span style="">2017/10/05 21:57:31 Adding path: /hello [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 9</span><span style="">2017/10/05 21:57:32 Adding path: /hello [GET,HEAD]
</span><span style="background-color:#3c3d38;display:block;width:100%"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">10</span><span style="">10000000               122 ns/op               0 B/op          0 allocs/op
</span></span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">11</span><span style="">2017/10/05 21:57:33 Adding path: /test/:word [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">12</span><span style="">BenchmarkRouterDynamic-4        2017/10/05 21:57:33 Adding path: /test/:word [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">13</span><span style="">2017/10/05 21:57:33 Adding path: /test/:word [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">14</span><span style="">2017/10/05 21:57:33 Adding path: /test/:word [GET,HEAD]
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">15</span><span style="">2017/10/05 21:57:34 Adding path: /test/:word [GET,HEAD]
</span><span style="background-color:#3c3d38;display:block;width:100%"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">16</span><span style=""> 2000000               913 ns/op             784 B/op          6 allocs/op
</span></span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">17</span><span style="">PASS
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">18</span><span style="">ok      github.com/nbari/violetear      4.144s</span></code></pre>
</div>

<p>The router since always has been behaving quite well this mainly thanks to Go
itself and well, to the modest traffic it has been handling.</p>

<p>While doing some benchmarks and simulating some DDOS I found some patterns. All
were related to the way the <code>request.URL.Path</code> was handled, the thing I notice
is that the bigger the request path was the more memory allocations where used,
at the end was pretty much-making sense since by splitting the path by &lsquo;/&rsquo; a
slice was returned with all the possible parts of the path.</p>

<p>For example, for a request like:</p>

<pre><code class="language-html">/the/quick/brown/fox/jumps/over/the/lazy/dog
</code></pre>

<p>The router was creating a slice of  10 items:</p>

<pre><code class="language-go">[ the quick brown fox jumps over the lazy dog]
</code></pre>

<p>In many cases, this would never be defined as routes and could probably just be
server by a <strong>catch-all(*)</strong> handler.</p>

<p>To fix this, instead of splitting and returning a slice, the path is now parsed,
each component of the path from left to right is used to find within the set of
defined handlers, so for the same request shown before, the router converts it
to:</p>

<pre><code class="language-go">key := &quot;the&quot;
path := &quot;/quick/brown/fox/jumps/over/the/lazy/dog&quot;
</code></pre>

<p>It searches for a possible handler named <code>the</code> and if not will try again using
<code>/the/quick</code>:</p>

<pre><code class="language-go">key := &quot;quick&quot;
path := &quot;/brown/fox/jumps/over/the/lazy/dog&quot;
</code></pre>

<p>Ans so on until a handler matches the <code>key</code> or a 404 is returned.</p>

<p>This by principle made the router more efficient but now the challenge was how
to parse the path without creating allocations.</p>

<p>The tricky part was to avoid concatenating strings runes or bytes, by just using
the existing path and return chunks of the slice did the trick, the current code
is this:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 1</span><span style="color:#66d9ef">func</span><span style=""> </span><span style="">(</span><span style="color:#a6e22e">t</span><span style=""> </span><span style="color:#f92672">*</span><span style="color:#a6e22e">Trie</span><span style="">)</span><span style=""> </span><span style="color:#a6e22e">SplitPath</span><span style="">(</span><span style="color:#a6e22e">path</span><span style=""> </span><span style="color:#66d9ef">string</span><span style="">)</span><span style=""> </span><span style="">(</span><span style="color:#66d9ef">string</span><span style="">,</span><span style=""> </span><span style="color:#66d9ef">string</span><span style="">)</span><span style=""> </span><span style="">{</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 2</span><span style="">	</span><span style="color:#66d9ef">var</span><span style=""> </span><span style="color:#a6e22e">key</span><span style=""> </span><span style="color:#66d9ef">string</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 3</span><span style="">	</span><span style="color:#66d9ef">if</span><span style=""> </span><span style="color:#a6e22e">path</span><span style=""> </span><span style="color:#f92672">==</span><span style=""> </span><span style="color:#e6db74">&#34;&#34;</span><span style=""> </span><span style="">{</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 4</span><span style="">		</span><span style="color:#66d9ef">return</span><span style=""> </span><span style="color:#a6e22e">key</span><span style="">,</span><span style=""> </span><span style="color:#a6e22e">path</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 5</span><span style="">	</span><span style="">}</span><span style=""> </span><span style="color:#66d9ef">else</span><span style=""> </span><span style="color:#66d9ef">if</span><span style=""> </span><span style="color:#a6e22e">path</span><span style=""> </span><span style="color:#f92672">==</span><span style=""> </span><span style="color:#e6db74">&#34;/&#34;</span><span style=""> </span><span style="">{</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 6</span><span style="">		</span><span style="color:#66d9ef">return</span><span style=""> </span><span style="color:#a6e22e">path</span><span style="">,</span><span style=""> </span><span style="color:#e6db74">&#34;&#34;</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 7</span><span style="">	</span><span style="">}</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 8</span><span style="">	</span><span style="color:#66d9ef">for</span><span style=""> </span><span style="color:#a6e22e">i</span><span style=""> </span><span style="color:#f92672">:=</span><span style=""> </span><span style="color:#ae81ff">0</span><span style="">;</span><span style=""> </span><span style="color:#a6e22e">i</span><span style=""> </span><span style="">&lt;</span><span style=""> </span><span style="">len</span><span style="">(</span><span style="color:#a6e22e">path</span><span style="">);</span><span style=""> </span><span style="color:#a6e22e">i</span><span style="color:#f92672">++</span><span style=""> </span><span style="">{</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;"> 9</span><span style="">		</span><span style="color:#66d9ef">if</span><span style=""> </span><span style="color:#a6e22e">path</span><span style="">[</span><span style="color:#a6e22e">i</span><span style="">]</span><span style=""> </span><span style="color:#f92672">==</span><span style=""> </span><span style="color:#e6db74">&#39;/&#39;</span><span style=""> </span><span style="">{</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">10</span><span style="">			</span><span style="color:#66d9ef">if</span><span style=""> </span><span style="color:#a6e22e">i</span><span style=""> </span><span style="color:#f92672">==</span><span style=""> </span><span style="color:#ae81ff">0</span><span style=""> </span><span style="">{</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">11</span><span style="">				</span><span style="color:#66d9ef">return</span><span style=""> </span><span style="color:#a6e22e">t</span><span style="">.</span><span style="color:#a6e22e">SplitPath</span><span style="">(</span><span style="color:#a6e22e">path</span><span style="">[</span><span style="color:#ae81ff">1</span><span style="">:])</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">12</span><span style="">			</span><span style="">}</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">13</span><span style="">			</span><span style="color:#66d9ef">if</span><span style=""> </span><span style="color:#a6e22e">i</span><span style=""> </span><span style="">&gt;</span><span style=""> </span><span style="color:#ae81ff">0</span><span style=""> </span><span style="">{</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">14</span><span style="">				</span><span style="color:#a6e22e">key</span><span style=""> </span><span style="">=</span><span style=""> </span><span style="color:#a6e22e">path</span><span style="">[:</span><span style="color:#a6e22e">i</span><span style="">]</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">15</span><span style="">				</span><span style="color:#a6e22e">path</span><span style=""> </span><span style="">=</span><span style=""> </span><span style="color:#a6e22e">path</span><span style="">[</span><span style="color:#a6e22e">i</span><span style="">:]</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">16</span><span style="">				</span><span style="color:#66d9ef">if</span><span style=""> </span><span style="color:#a6e22e">path</span><span style=""> </span><span style="color:#f92672">==</span><span style=""> </span><span style="color:#e6db74">&#34;/&#34;</span><span style=""> </span><span style="">{</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">17</span><span style="">					</span><span style="color:#66d9ef">return</span><span style=""> </span><span style="color:#a6e22e">key</span><span style="">,</span><span style=""> </span><span style="color:#e6db74">&#34;&#34;</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">18</span><span style="">				</span><span style="">}</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">19</span><span style="">				</span><span style="color:#66d9ef">return</span><span style=""> </span><span style="color:#a6e22e">key</span><span style="">,</span><span style=""> </span><span style="color:#a6e22e">path</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">20</span><span style="">			</span><span style="">}</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">21</span><span style="">		</span><span style="">}</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">22</span><span style="">	</span><span style="">}</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">23</span><span style="">	</span><span style="color:#66d9ef">return</span><span style=""> </span><span style="color:#a6e22e">path</span><span style="">,</span><span style=""> </span><span style="color:#e6db74">&#34;&#34;</span><span style="">
</span><span style="color:#7c7c79;margin-right:0.4em;padding:00.4em00.4em;">24</span><span style=""></span><span style="">}</span></code></pre>
</div>

<p>The routers now is faster and static routes are 0% fat üöÄ.</p>

<p>There still work in progress - who would think that behind a simple router
there is too much logic evolved.</p>

<p>The experience so far has being very pleasant, learning and improving every day
more about go and its niceties.</p>

<p>Any tips, comments or a review will be more than welcome üôè</p>

                </section>
            </article>


            <footer id="post-meta" class="clearfix">

    <a href="https://github.com/nbari/violetear-docs/edit/master/post/allocs.md" target="_blank">Suggest edit ‚úçÔ∏è</a>

                
                    
                <section id="sharing">
                    <a class="twitter" href="https://twitter.com/intent/tweet?text=https%3a%2f%2fvioletear.org%2fpost%2fallocs%2f - Benchmarks%20and%20profiling "><span class="icon-twitter"> Tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

                </section>
            </footer>

            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "violetear" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            <ul id="post-list" class="archive readmore">
    <h3>Read more</h3>
    
    
        
        <li>
            <a href="https://violetear.org/post/how-it-works/">How it works</a>
        </li>
        
   
    
        
        <li>
            <a href="https://violetear.org/post/usage/">Usage</a>
        </li>
        
   
    
        
        <li>
            <a href="https://violetear.org/post/middleware/">Middleware</a>
        </li>
        
   
    
        
        <li>
            <a href="https://violetear.org/post/context-named/">Context &amp; Named parameters</a>
        </li>
        
   
    
        
        <li>
            <a href="https://violetear.org/post/versioning/">Versioning</a>
        </li>
        
   
    
        
        <li>
            <a href="https://violetear.org/post/requestid/">RequestID</a>
        </li>
        
   
    
        
        <li>
            <a href="https://violetear.org/post/notfoundhandler/">NotFoundHandler</a>
        </li>
        
   
    
        
        <li>
            <a href="https://violetear.org/post/notallowedhandler/">NotAllowedHandler</a>
        </li>
        
   
    
        
        <li>
            <a href="https://violetear.org/post/panichandler/">PanicHandler</a>
        </li>
        
   
    
        
        <li>
            <a href="https://violetear.org/post/allocs/">Benchmarks and profiling</a>
        </li>
        
   
</ul>
            <footer id="footer">
    
        <div id="social">

	
	
    
    <a class="symbol" href="https://github.com/nbari/violetear">
        circlegithub
    </a>
    


</div>

    
    <p class="small">
    
        
    
    </p>
</footer>

        </section>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://violetear.org/js/main.js"></script>
<script src="https://violetear.org/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-69163599-1', 'auto');
ga('send', 'pageview');
</script>


    </body>
</html>
